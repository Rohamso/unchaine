<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Messages</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
  /* message menu */
  .msg-menu{
    position:absolute; z-index:9999;
    background:#fff; color:#111;
    border:1px solid #e5e7eb; border-radius:10px;
    box-shadow:0 10px 30px rgba(0,0,0,.08);
    padding:6px; min-width:140px; display:none;
  }
  .msg-menu.open{ display:block; }
  .msg-menu button{
    display:block; width:100%; text-align:left;
    background:transparent; border:0; padding:8px 10px; border-radius:8px; cursor:pointer;
    font:inherit; color:inherit;
  }
  .msg-menu button:hover{ background:#f5f5f7; }
    :root{ --bg:#f5f5f7; --panel:#ffffff; --text:#111; --muted:#6b7280;
           --me:#0b84ff; --me-text:#fff; --them:#e9e9eb; --them-text:#111;
           --bar:#f8f8fb; --border:#e5e7eb; --accent:#0b84ff; }
    *{box-sizing:border-box} html,body{height:100%;margin:0}
    body{font:16px -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:var(--text);background:var(--bg)}
    .app{display:flex;flex-direction:column;height:100%}
    .top{position:sticky;top:0;z-index:10;background:var(--bar);border-bottom:1px solid var(--border)}
    .top-inner{max-width:900px;margin:0 auto;padding:10px 12px;display:flex;align-items:center;gap:8px}
    .title{font-weight:600;margin-right:auto}
    .status{display:flex;align-items:center;gap:8px;color:var(--muted);font-size:14px}
    .dot{width:8px;height:8px;border-radius:50%;background:#bbb}.dot.on{background:#10b981}
    .controls{max-width:900px;margin:0 auto;padding:8px 12px;display:grid;
      grid-template-columns:1fr 1.2fr .7fr auto; gap:8px; border-top:1px solid var(--border); background:var(--panel)}
    .controls input{padding:10px;border:1px solid var(--border);border-radius:10px}
    .controls button{padding:10px 14px;border:1px solid var(--accent);background:var(--accent);color:#fff;border-radius:10px;cursor:pointer}
    .controls button.secondary{background:#fff;color:var(--accent)}
    .hidden{display:none!important}
    .wrap{max-width:900px;margin:0 auto;flex:1;display:flex;flex-direction:column}
    .msgs{flex:1;overflow:auto;padding:12px;display:flex;flex-direction:column;gap:10px}
    .row{display:flex;gap:8px;align-items:flex-end}
    .row.me{justify-content:flex-end}
    .bubble{max-width:min(72%,560px);padding:10px 12px;border-radius:18px;line-height:1.35;white-space:pre-wrap;word-wrap:break-word}
    .me .bubble{background:var(--me);color:var(--me-text);border-bottom-right-radius:6px}
    .them .bubble{background:var(--them);color:var(--them-text);border-bottom-left-radius:6px}
    .meta{font-size:12px;color:var(--muted);margin:0 6px}
    .inputbar{padding:10px 12px;border-top:1px solid var(--border);background:var(--panel);display:flex;gap:8px}
    .inputbar textarea{flex:1;resize:none;max-height:140px;min-height:42px;padding:10px 12px;border:1px solid var(--border);border-radius:20px;outline:none}
    .send{padding:10px 16px;border:none;background:var(--accent);color:#fff;border-radius:18px;cursor:pointer}
    .badge{font-size:12px;padding:2px 8px;border-radius:999px;border:1px solid var(--border);color:var(--muted)}
    @media (max-width:700px){ .controls{grid-template-columns:1fr} }
  </style>
</head>
<body>
<div class="app">
  <div class="top">
    <div class="top-inner">
      <div class="title">Messages</div>
      <div class="status"><span id="statusDot" class="dot"></span><span id="statusText">Disconnected</span></div>
      <button id="toggleCfg" class="badge" title="Show/Hide settings">Settings</button>
    </div>
    <div id="cfg" class="controls">
      <input id="room" placeholder="Room" value="demo-room-1"/>
      <input id="signalUrl" placeholder="wss://signal.unchaine.com" value="wss://signal.unchaine.com"/>
      <input id="turn" placeholder="TURN (optional): turn:turn.yourdomain.com:3478"/>
      <button id="joinBtn">Join</button>
      <button id="leaveBtn" class="secondary">Leave</button>
    </div>
  </div>

  <div class="wrap">
    <div id="msgs" class="msgs"></div>
    <div class="inputbar">
      <textarea id="msg" placeholder="Send a message"></textarea>
      <button id="sendBtn" class="send">Send</button>
    </div>
  </div>
</div>

<script src="https://unpkg.com/simple-peer@9.11.1/simplepeer.min.js"></script>
<script>
// --- message menu helpers
let openMenu; // ref to currently open menu

function closeAnyMenu(){
  if (openMenu) { openMenu.classList.remove('open'); openMenu.remove(); openMenu = null; }
}
document.addEventListener('click', (e)=> {
  // close on outside click
  if (openMenu && !openMenu.contains(e.target)) closeAnyMenu();
});

function showMessageMenu(anchorBtn, { text, offenderId, ts }) {
  closeAnyMenu();

  const menu = document.createElement('div');
  menu.className = 'msg-menu';
  const btn = document.createElement('button');
  btn.textContent = 'Report';
  btn.onclick = async () => {
    closeAnyMenu();
    // optional confirm
    if (!confirm('Report this message?')) return;
    await reportMessage({ text, offenderId, ts });
    alert('Thanks—reported.');
  };
  menu.appendChild(btn);
  document.body.appendChild(menu);

  // position menu near the anchor button
  const r = anchorBtn.getBoundingClientRect();
  menu.style.left = `${window.scrollX + r.left - 10}px`;
  menu.style.top  = `${window.scrollY + r.bottom + 6}px`;
  menu.classList.add('open');
  openMenu = menu;
}
// --- moderation helpers
let bannedHashes = new Set();
let myPeerId = null; // optional: set this if you expose your own id
const SIGNAL_BASE = 'https://signal.unchaine.com'; // must be https

async function fetchBannedHashes(){
  try {
    const txt = await fetch(`${SIGNAL_BASE}/banned-hashes`, { cache: 'no-store' }).then(r=>r.text());
    bannedHashes = new Set(
      txt.split(/\r?\n/).map(s=>s.trim()).filter(Boolean).filter(l=>!l.startsWith('#'))
    );
    console.log('Banned hashes loaded', bannedHashes.size);
  } catch (e) { console.warn('banned-hashes fetch failed', e); }
}

async function sha256Hex(str){
  const enc = new TextEncoder().encode(str);
  const buf = await crypto.subtle.digest('SHA-256', enc);
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
}

async function reportMessage({ text, offenderId='unknown', ts=Date.now() }){
  const room = (document.getElementById('room')?.value || 'default').trim().toLowerCase();
  const reporterId = myPeerId || ('web-'+Math.random().toString(36).slice(2));
  try {
    const res = await fetch(`${SIGNAL_BASE}/report`, {
      method:'POST',
      headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify({ room, offenderId, reporterId, message: text, ts })
    });
    const j = await res.json();
    alert(j.ok ? 'Reported. Thank you.' : 'Report failed.');
  } catch { alert('Report failed (network).'); }
}

window.addEventListener('load', fetchBannedHashes);
  // --- state
  let ws=null, joined=false;
  const peers=new Map();                 // peerId -> SimplePeer
  const enc=new TextEncoder(), dec=new TextDecoder();
  const statusDot=document.getElementById('statusDot');
  const statusText=document.getElementById('statusText');
  const msgsEl=document.getElementById('msgs');
  const input=document.getElementById('msg');

  // --- ui helpers
  function pad(n){return n<10?'0'+n:''+n}
  function tsLabel(ts){const d=new Date(ts??Date.now());return `${pad(d.getHours())}:${pad(d.getMinutes())}`}
  function bubble({self,text,ts,fromPeerId}){
    if(self){
      const row=document.createElement('div'); row.className='row me';
      const b=document.createElement('div'); b.className='bubble'; b.textContent=text;
      const meta=document.createElement('div'); meta.className='meta'; meta.textContent=tsLabel(ts);
      row.appendChild(b); row.appendChild(meta);
      msgsEl.appendChild(row); msgsEl.scrollTop=msgsEl.scrollHeight;
    }else{
      renderIncomingMessage({text,fromPeerId,ts});
    }
  }

  function renderIncomingMessage({ text, fromPeerId, ts }) {
    const row = document.createElement('div');
    row.className = 'row them';

    const meta = document.createElement('div');
    meta.className = 'meta';
    meta.textContent = new Date(ts || Date.now()).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});

    const bubble = document.createElement('div');
    bubble.className = 'bubble';
    bubble.textContent = text;

    const more = document.createElement('button');
    more.textContent = '⋯';
    more.style = 'border:none;background:transparent;color:#889;cursor:pointer;font-size:16px;';
    more.title = 'More';
    more.onclick = (ev) => {
      ev.stopPropagation();
      showMessageMenu(more, { text, offenderId: fromPeerId || 'unknown', ts });
    };

    row.append(meta, bubble, more);
    document.getElementById('msgs').appendChild(row);
    msgsEl.scrollTop = msgsEl.scrollHeight;
  }
  function setStatus(on){ statusDot.classList.toggle('on',!!on); statusText.textContent=on?'Connected':'Disconnected' }
  document.getElementById('toggleCfg').onclick=()=>document.getElementById('cfg').classList.toggle('hidden');

  // --- join/leave (same behavior as the app)
  document.getElementById('joinBtn').onclick=()=>{
    if(joined) return;
    let room=(document.getElementById('room').value||'demo-room-1').trim().toLowerCase();
    const url=document.getElementById('signalUrl').value.trim();
    const turn=document.getElementById('turn').value.trim();
    if(!url) return alert('Enter signaling URL');

    ws=new WebSocket(url);
    ws.onopen=()=>{ setStatus(true); ws.send(JSON.stringify({type:'join',room})); document.getElementById('cfg').classList.add('hidden'); };
    ws.onerror=()=> setStatus(false);
    ws.onclose=()=>{ setStatus(false); joined=false; };

    ws.onmessage=(ev)=>{
      const msg=JSON.parse(ev.data);
      if(msg.type==='peers'){ joined=true; for(const pid of msg.peers) startPeer(pid,true,turn); }
      else if(msg.type==='new-peer'){ startPeer(msg.id,false,turn); }
      else if(msg.type==='signal'){ const p=peers.get(msg.from)||startPeer(msg.from,false,turn); p.signal(msg.data); }
    };
  };

  document.getElementById('leaveBtn').onclick=()=>{
    try{ ws&&ws.close(); }catch{}
    for(const [,p] of peers){ try{ p.destroy(); }catch{} }
    peers.clear(); setStatus(false); joined=false;
    bubble({self:false,text:'You left the room',ts:Date.now()});
  };

  // --- webrtc
  function iceServers(turn){ const arr=[{urls:['stun:stun.l.google.com:19302']}]; if(turn) arr.push({urls:[turn],username:'demoUser',credential:'demoPass_ChangeMe'}); return arr; }
  function toU8(d){ if(d instanceof Uint8Array) return d; if(d instanceof ArrayBuffer) return new Uint8Array(d);
                    if(d&&d.data instanceof ArrayBuffer) return new Uint8Array(d.data);
                    if(typeof d==='string') return enc.encode(d); try{return enc.encode(String(d))}catch{return new Uint8Array()} }

  function startPeer(peerId, initiator, turn){
    if(peers.has(peerId)) return peers.get(peerId);
    const p=new SimplePeer({ initiator, trickle:false, config:{ iceServers: iceServers(turn) }});
    peers.set(peerId,p);

    p.on('signal', data=> ws?.send(JSON.stringify({type:'signal', target:peerId, data})));
    p.on('connect', ()=> bubble({self:false,text:`Connected to ${peerId}`,ts:Date.now()}));
    p.on('close', ()=>{ peers.delete(peerId); bubble({self:false,text:`Closed ${peerId}`,ts:Date.now()}); });
    p.on('error', e=> bubble({self:false,text:`Peer error: ${e.message}`,ts:Date.now()}));

    // Single receive handler: decode bytes → text → JSON
    p.on('data', (data)=>{
      const u8=toU8(data);
      let text='';
      try{ text=dec.decode(u8); }catch{ bubble({self:false,text:`[binary ${u8.byteLength}B]`,ts:Date.now()}); return; }
      try{
        const obj=JSON.parse(text);
        if(obj&&obj.type==='chat'){
          bubble({self:false,text:obj.text,ts:obj.ts,fromPeerId:'unknown'});
          return;
        }
      }catch{}
  bubble({self:false,text,ts:Date.now(),fromPeerId:'unknown'});
    });

    return p;
  }

  // --- send
  function sendCurrent(){
    const text = input.value.trim();
    if (!text) return;
    sha256Hex(text).then(h => {
      if (bannedHashes.has(h)) {
        alert('This content is blocked by policy.');
        return;
      }
      const payload = enc.encode(JSON.stringify({type:'chat',text,ts:Date.now()}));
      for(const [,p] of peers){ try{ p.send(payload); }catch{} }
      bubble({self:true,text,ts:Date.now()});
      input.value='';
    });
  }
  document.getElementById('sendBtn').onclick=sendCurrent;
  input.addEventListener('keydown',e=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendCurrent(); }});
</script>
</script>
<script>

  // report API (reuses your existing reportMessage if present)
  async function reportMessage({ text, offenderId='unknown', ts=Date.now() }){
    const room = (document.getElementById('room')?.value || 'default').trim().toLowerCase();
    const reporterId = 'web-'+Math.random().toString(36).slice(2);
    const res = await fetch(`${SIGNAL_BASE}/report`, {
      method:'POST',
      headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify({ room, offenderId, reporterId, message: text, ts })
    });
    if(!res.ok){ alert('Report failed'); return; }
    alert('Thanks—reported.');
  }

  // menu helpers
  let openMenu = null;
  function closeAnyMenu(){
    if (openMenu){ openMenu.classList.remove('open'); openMenu.remove(); openMenu = null; }
  }
  document.addEventListener('click', (e)=>{
    if (openMenu && !openMenu.contains(e.target)) closeAnyMenu();
  });

  function showMessageMenu(anchorBtn, { text, offenderId, ts }){
    closeAnyMenu();
    const menu = document.createElement('div');
    menu.className = 'msg-menu';

    const btn = document.createElement('button');
    btn.textContent = 'Report';
    btn.onclick = async () => {
      closeAnyMenu();
      if (!confirm('Report this message?')) return;
      await reportMessage({ text, offenderId, ts });
    };

    menu.appendChild(btn);
    document.body.appendChild(menu);

    const r = anchorBtn.getBoundingClientRect();
    menu.style.left = `${window.scrollX + r.left - 10}px`;
    menu.style.top  = `${window.scrollY + r.bottom + 6}px`;
    menu.classList.add('open');
    openMenu = menu;
  }
</script>
</body>
</html>
