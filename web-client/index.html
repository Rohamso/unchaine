<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Messages</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    :root{
      --bg:#f5f5f7; --panel:#ffffff; --text:#111; --muted:#6b7280;
      --me:#0b84ff; --me-text:#fff; --them:#e9e9eb; --them-text:#111;
      --border:#e5e7eb; --accent:#0b84ff;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0}
    body{font:16px -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:var(--text);background:var(--bg);}
    .app{height:100%;display:flex;flex-direction:column}
    .statusbar{padding:10px 12px;color:var(--muted);font-size:14px}
    .dot{display:inline-block;width:8px;height:8px;border-radius:50%;background:#bbb;margin-right:6px;vertical-align:middle}
    .dot.on{background:#10b981}
    .wrap{max-width:900px;margin:0 auto;flex:1;display:flex;flex-direction:column}
    .msgs{flex:1;overflow:auto;padding:12px;display:flex;flex-direction:column;gap:10px}
    .row{display:flex;gap:8px;align-items:flex-end}
    .row.me{justify-content:flex-end}
    .bubble{max-width:min(72%,560px);padding:10px 12px;border-radius:18px;line-height:1.35;white-space:pre-wrap;word-wrap:break-word}
    .me .bubble{background:var(--me);color:var(--me-text);border-bottom-right-radius:6px}
    .them .bubble{background:var(--them);color:var(--them-text);border-bottom-left-radius:6px}
    .meta{font-size:12px;color:var(--muted);margin:0 6px}
    .inputbar{padding:10px 12px;border-top:1px solid var(--border);background:var(--panel);display:flex;gap:8px}
    .inputbar textarea{flex:1;resize:none;max-height:140px;min-height:42px;padding:10px 12px;border:1px solid var(--border);border-radius:20px;outline:none}
    .send{padding:10px 16px;border:none;background:var(--accent);color:#fff;border-radius:18px;cursor:pointer}
  </style>
</head>
<body>
<div class="app">
  <div class="statusbar"><span id="dot" class="dot"></span><span id="status">Connecting…</span></div>
  <div class="wrap">
    <div id="msgs" class="msgs"></div>
    <div class="inputbar">
      <textarea id="msg" placeholder="iMessage…"></textarea>
      <button id="sendBtn" class="send">Send</button>
    </div>
  </div>
</div>

<!-- SimplePeer -->
<script src="https://unpkg.com/simple-peer@9.11.1/simplepeer.min.js"></script>
<script>
  // ======== EDIT THESE DEFAULTS IF YOU WANT ========
  const SIGNAL_URL = "wss://signal.unchaine.com";
  const ROOM       = "demo-room-1";
  const TURN_URL   = ""; // e.g. "turn:turn.yourdomain.com:3478" (optional)
  // =================================================

  // state
  let ws=null;
  const peers=new Map(); // id -> SimplePeer
  const enc=new TextEncoder(), dec=new TextDecoder();

  // ui
  const dot=document.getElementById('dot');
  const status=document.getElementById('status');
  const msgsEl=document.getElementById('msgs');
  const input=document.getElementById('msg');
  const sendBtn=document.getElementById('sendBtn');

  function setStatus(txt, on){ status.textContent=txt; dot.classList.toggle('on', !!on) }
  function pad(n){return n<10?'0'+n:''+n}
  function tsLabel(ts){const d=new Date(ts??Date.now());return `${pad(d.getHours())}:${pad(d.getMinutes())}`}
  function bubble({self,text,ts}){
    const row=document.createElement('div'); row.className='row '+(self?'me':'them');
    const b=document.createElement('div'); b.className='bubble'; b.textContent=text;
    const meta=document.createElement('div'); meta.className='meta'; meta.textContent=tsLabel(ts);
    if(self){ row.appendChild(b); row.appendChild(meta);} else { row.appendChild(meta); row.appendChild(b); }
    msgsEl.appendChild(row); msgsEl.scrollTop=msgsEl.scrollHeight;
  }

  function iceServers(){ const arr=[{urls:['stun:stun.l.google.com:19302']}]; if(TURN_URL) arr.push({urls:[TURN_URL],username:'demoUser',credential:'demoPass_ChangeMe'}); return arr; }
  function toU8(d){ if(d instanceof Uint8Array) return d; if(d instanceof ArrayBuffer) return new Uint8Array(d); if(d&&d.data instanceof ArrayBuffer) return new Uint8Array(d.data); if(typeof d==='string') return enc.encode(d); try{return enc.encode(String(d))}catch{return new Uint8Array()} }

  function startPeer(peerId, initiator){
    if(peers.has(peerId)) return peers.get(peerId);
    const p=new SimplePeer({ initiator, trickle:false, config:{ iceServers: iceServers() }});
    peers.set(peerId,p);

    p.on('signal', data=> ws?.send(JSON.stringify({type:'signal', target:peerId, data})));
    p.on('connect', ()=> bubble({self:false,text:`Connected to ${peerId}`,ts:Date.now()}));
    p.on('close', ()=>{ peers.delete(peerId); bubble({self:false,text:`Closed ${peerId}`,ts:Date.now()}); });
    p.on('error', e=> bubble({self:false,text:`Peer error: ${e.message}`,ts:Date.now()}));

    p.on('data', (data)=>{
      const u8=toU8(data);
      let text='';
      try{ text=dec.decode(u8); }catch{ bubble({self:false,text:`[binary ${u8.byteLength}B]`,ts:Date.now()}); return; }
      try{ const obj=JSON.parse(text); if(obj&&obj.type==='chat'){ bubble({self:false,text:obj.text,ts:obj.ts}); return; } }catch{}
      bubble({self:false,text,ts:Date.now()});
    });

    return p;
  }

  function sendCurrent(){
    const text=input.value.trim(); if(!text) return;
    const payload=enc.encode(JSON.stringify({type:'chat',text,ts:Date.now()}));
    for(const [,p] of peers){ try{ p.send(payload); }catch{} }
    bubble({self:true,text,ts:Date.now()}); input.value='';
  }
  sendBtn.onclick=sendCurrent;
  input.addEventListener('keydown',e=>{ if(e.key==='Enter'&&!e.shiftKey){ e.preventDefault(); sendCurrent(); }});

  // connect immediately
  (function connect(){
    setStatus("Connecting…", false);
    ws=new WebSocket(SIGNAL_URL);
    ws.onopen=()=>{ setStatus("Connected", true); ws.send(JSON.stringify({type:'join', room: ROOM.trim().toLowerCase()})); };
    ws.onerror=()=> setStatus("Error", false);
    ws.onclose=()=> setStatus("Disconnected", false);
    ws.onmessage=(ev)=>{
      const msg=JSON.parse(ev.data);
      if(msg.type==='peers'){ for(const pid of msg.peers) startPeer(pid,true); }
      else if(msg.type==='new-peer'){ startPeer(msg.id,false); }
      else if(msg.type==='signal'){ (peers.get(msg.from)||startPeer(msg.from,false)).signal(msg.data); }
    };
  })();
</script>
</body>
</html>
