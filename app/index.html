<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>P2P Web Client</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    body { font:14px system-ui, sans-serif; margin:16px; max-width:900px }
    input { padding:8px; width:100%; max-width:520px; margin:4px 0 }
    textarea { width:100%; height:160px; padding:8px; }
    button { padding:8px 12px; margin-right:6px }
  </style>
</head>
<body>
  <h2>P2P Web Client</h2>

  <label>Room
    <input id="room" value="demo-room-1"/>
  </label>
  <label>Signaling URL
    <input id="signalUrl" value="wss://signal.yourdomain.com"/>
  </label>
  <label>TURN (optional)
    <input id="turn" placeholder="turn:turn.yourdomain.com:3478"/>
  </label>
  <div>
    <button id="joinBtn">Join</button>
    <button id="leaveBtn">Leave</button>
  </div>

  <h3>Chat</h3>
  <textarea id="log" readonly></textarea><br/>
  <input id="msg" placeholder="Type messageâ€¦"/>
  <button id="sendBtn">Send</button>

  <script src="https://unpkg.com/simple-peer@9.11.1/simplepeer.min.js"></script>
  <script>
    // ---- helpers
    const enc = new TextEncoder();
    const dec = new TextDecoder();
    const logBox = document.getElementById('log');
    function log(s){ logBox.value += s + '\n'; logBox.scrollTop = logBox.scrollHeight }

    function normalizeToU8(d){
      if (d instanceof Uint8Array) return d;
      if (d instanceof ArrayBuffer) return new Uint8Array(d);
      if (d && d.data instanceof ArrayBuffer) return new Uint8Array(d.data);
      if (typeof d === 'string') return enc.encode(d);
      try { return enc.encode(String(d)) } catch { return new Uint8Array() }
    }

    // ---- state
    let ws = null;
    const peers = new Map(); // id -> SimplePeer

    function getIce(){
      const t = document.getElementById('turn').value.trim();
      const ice = [{ urls: ['stun:stun.l.google.com:19302'] }];
      if (t) ice.push({ urls:[t], username:'demoUser', credential:'demoPass_ChangeMe' });
      return ice;
    }

    // ---- signaling
    document.getElementById('joinBtn').onclick = () => {
      let room = (document.getElementById('room').value || 'demo-room-1').trim().toLowerCase();
      const url  = document.getElementById('signalUrl').value.trim();
      if (!url) return alert('Enter signaling URL');

      log(`Connecting to signaling: ${url}`);
      ws = new WebSocket(url);
      ws.onopen = () => { log('Connected to signaling'); ws.send(JSON.stringify({type:'join', room})); };
      ws.onerror = () => log('Signaling error');
      ws.onclose = () => log('Disconnected from signaling');

      ws.onmessage = (ev) => {
        const msg = JSON.parse(ev.data);
        if (msg.type === 'peers') {
          for (const pid of msg.peers) startPeer(pid, true);
        } else if (msg.type === 'new-peer') {
          startPeer(msg.id, false);
        } else if (msg.type === 'signal') {
          const p = peers.get(msg.from) || startPeer(msg.from, false);
          p.signal(msg.data);
        }
      };
    };

    document.getElementById('leaveBtn').onclick = () => {
      try { ws && ws.close(); } catch {}
      for (const [,p] of peers) { try { p.destroy(); } catch {} }
      peers.clear();
      log('Left room');
    };

    // ---- peer
    function startPeer(peerId, initiator){
      if (peers.has(peerId)) return peers.get(peerId);

      const p = new SimplePeer({ initiator, trickle:false, config:{ iceServers: getIce() } });
      peers.set(peerId, p);

      p.on('signal', data => ws?.send(JSON.stringify({type:'signal', target:peerId, data})));
      p.on('connect', () => log(`Connected to ${peerId}`));
      p.on('close',   () => { peers.delete(peerId); log(`Closed ${peerId}`) });
      p.on('error',   (e) => log(`Peer error (${peerId}): ${e.message}`));

      // SINGLE receive handler: decode bytes -> text -> JSON
      // SINGLE receive handler: decode bytes -> text -> JSON
      p.on('data', (data) => {
        const u8 = normalizeToU8(data);
        let text = '';
        let decodeFailed = false;
        try {
          text = dec.decode(u8);
        } catch {
          decodeFailed = true;
        }

        if (decodeFailed) {
          log(`${peerId}: [binary ${u8.byteLength}B]`);
          return;
        }

        // Try to parse JSON (Electron sends JSON bytes: {type:'chat', text})
        try {
          const obj = JSON.parse(text);
          if (obj && obj.type === 'chat') {
            log(`${peerId}: ${obj.text}`);
            return;
          }
        } catch { /* not JSON; fall through */ }

        // Plain text fallback
        log(`${peerId}: ${text}`);
      });

      return p;
    }

    // ---- send
    document.getElementById('sendBtn').onclick = () => {
      const text = document.getElementById('msg').value;
      if (!text) return;
      const payload = enc.encode(JSON.stringify({ type:'chat', text }));
      for (const [,p] of peers) { try { p.send(payload); } catch {} }
      log(`Me: ${text}`);
      document.getElementById('msg').value = '';
    };
  </script>
</body>
</html>
